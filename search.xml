<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[anime top 20]]></title>
      <url>https://winry.me/2016/08/02/anime%20top%2020/</url>
      <content type="html"><![CDATA[<p> （三年前写的TOP20，补充几部这几年看过比较好的。高达00，圣母在上，京吹部，女子落语，touch，TT，月刊少女，邻座的怪同学，悠哉，飞跃巅峰1，还有幸运星不知道当时为什么没排进去）</p>
<hr>
<p>个人向，不公正，不客观，排名不分先后</p>
<h3 id="凉宫春日的忧郁">凉宫春日的忧郁</h3><p>京都的轻改巅峰，不少人的入宅作，1096的冒险，永无止境的八月，团长和囧虚的吻戏太棒。</p>
<p><img src="/img/凉宫09.jpg" alt=""></p>
<h3 id="食灵零">食灵零</h3><p>最喜欢的黑长直，没有之一，命运如此悲惨的女主大概没有第二个了。百合的部分也食的开心。</p>
<p><img src="/img/食灵零.jpg" alt=""></p>
<h3 id="k-on!">k-on!</h3><p>入宅作，呆唯本命，希望京都把废萌永远进行下去。</p>
<p><img src="/img/k-on.jpg" alt=""></p>
<h3 id="侧耳倾听">侧耳倾听</h3><p>吉卜力唯一喜欢的作品吧，《coutry road》插入的很棒，尤其喜欢女主住宅的作画,明亮的色彩让人有心底敞开的温馨感。</p>
<p><img src="/img/侧耳倾听.jpg" alt=""></p>
<h3 id="龙与虎">龙与虎</h3><p>二次元女神实乃梨w，龙儿好男主，人物的刻画非常细腻，节奏把握也特别好的轻改，心目中节操社的最好作品。</p>
<p><img src="/img/龙与虎.jpg" alt=""></p>
<h3 id="化物语">化物语</h3><p>神作之壁，销量最好的轻改，垃圾君和荡漾在星空下的那一段也是名场景了，西尾的废话流配合新房的独特风格意外的有趣。(不过物语系列后面就都很烂了,当然销量还是摆在那)</p>
<p><img src="/img/化物语.jpg" alt=""></p>
<h3 id="钢之炼金术师FA">钢之炼金术师FA</h3><p>王道作品，长番剧情却一点也不拖沓，打戏精彩，热血的同时也讨论了哲理，yui的声音超棒。</p>
<p><img src="/img/钢炼fa.jpg" alt=""></p>
<h3 id="白色相簿">白色相簿</h3><p>最令我纠结的一部作品了，虽然全员倒贴，男主又处处留情，仍然很难判断他的对错，蛮耐人寻味的展开,以及奈姬经典的《深爱》。</p>
<p><img src="/img/wa.jpg" alt=""></p>
<h3 id="君望">君望</h3><p>最好的恋爱番， 个人还是倾向于はるか的。</p>
<p><img src="/img/君望.jpg" alt=""></p>
<h3 id="神枪少女（一期）">神枪少女（一期）</h3><p>和fate的主仆设定相比各有风味，氛围很好的片子，刻画义体少女独有的纤细情感(反差萌?)。</p>
<p><img src="/img/神枪少女.jpg" alt=""></p>
<h3 id="黑之契约者（全期）">黑之契约者（全期）</h3><p>黑叔最叼的男主，那年香菜还不是兵库北，打斗超棒，有生之年系列。</p>
<p><img src="/img/黑之契约者.jpg" alt=""></p>
<h3 id="EVA">EVA</h3><p>嘛，不需要多说，心目中一号机的暴走是宇宙最强暴走。</p>
<p><img src="/img/eva.jpg" alt=""></p>
<h3 id="命运石之门">命运石之门</h3><p>良心，大量铺垫之后包袱抖落的那一刻能只能赞叹精彩了。</p>
<p><img src="/img/命运石之门.jpg" alt=""></p>
<h3 id="全金属狂潮(校园篇)">全金属狂潮(校园篇)</h3><p>又是一部轻改，外传超越本篇的作品，京都拍校园就是这么叼。</p>
<p><img src="/img/全金校园篇.jpg" alt=""></p>
<h3 id="现视研">现视研</h3><p>巨细无遗的描述オタク的作品，不过演出最精彩的反而是三位女性角色了，好看。</p>
<p><img src="/img/现视研.jpg" alt=""></p>
<h3 id="clannad(一期)">clannad(一期)</h3><p>风子的电波实在太合我的胃口了，二期虽然血泪，个人还是更喜欢一期轻松温馨的校园生活。</p>
<p><img src="/img/clannad.jpg" alt=""></p>
<h3 id="日常">日常</h3><p>宅男品味大日常，电波一旦对上了就根本停不下来。京都作画水平充分体现的一部作品。</p>
<p><img src="/img/日常.jpg" alt=""></p>
<h3 id="最终兵器彼女">最终兵器彼女</h3><p>还未入宅时就最喜欢的私货，战争与爱情是永不过时的题材。</p>
<p><img src="/img/最终兵器彼女.jpg" alt=""></p>
<h3 id="竹刀少女">竹刀少女</h3><p>友情，努力，胜利，JUMP三要素，各位耍竹刀的少女实在是又帅又萌。</p>
<p><img src="/img/竹刀少女.jpg" alt=""></p>
<h3 id="咲-SAKI">咲-SAKI</h3><p>又萌又燃，天麻对我来说也不是简单的一部动画了，日麻还是给我带来了很多东西的，压轴也不为过吧。</p>
<p><img src="/img/天麻.jpg" alt=""></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[spring data jpa fetch mode]]></title>
      <url>https://winry.me/2016/05/26/spring-data-jpa-fetch-mode/</url>
      <content type="html"><![CDATA[<p>虽然hibernate里好几种fetch mode.</p>
<ul>
<li>SELECT</li>
<li>SELECT with BatchSize</li>
<li>JOIN</li>
<li>SUBSELCT</li>
</ul>
<p>但是JPA里只有两种类型的fetching:<code>EAGER</code>和<code>LAZY</code>。在使用spring data jpa的时候，为了解决n+1查询问题，我们需要在查询中手动的控制fetch mode。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPagedSpecificationProjection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Specification&lt;Person&gt; spec = <span class="keyword">new</span> Specification&lt;Person&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Predicate <span class="title">toPredicate</span><span class="params">(Root&lt;Person&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder cb)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (Long.class != query.getResultType()) &#123;</span><br><span class="line">                    root.fetch(Person_.addresses);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> cb.conjunction();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Pageable pageable = <span class="keyword">new</span> PageRequest(<span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">        Page&lt;Person&gt; page = personRepo.findAll(spec, pageable);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>第四行判断了返回类型是否为Long，是因为分页查询时spring data会先执行一次count查询，此时关联对count查询是没有意义的，会一个抛异常：</p>
<blockquote>
<p>org.hibernate.QueryException: query specified join fetching, but the owner of the fetched association was not present in the select list</p>
</blockquote>
<p>如果不是分页查询，则不需要判断返回类型。</p>
<p>顺带一提，关于jpa里的@OneToOne关联，如果关联的表允许为空，即<code>optional=true</code>，那么<code>fetch = FetchType.LAZY</code>是不起作用的，具体的解释参考：<a href="https://developer.jboss.org/wiki/SomeExplanationsOnLazyLoadingone-to-one" target="_blank" rel="external">SomeExplanationsOnLazyLoadingone-to-one</a>。<code>@OneToOne</code>的双向关联一定要慎用，一不小心就会造成n+1查询问题。</p>
<p>参考:<a href="https://jira.spring.io/browse/DATAJPA-105" target="_blank" rel="external">https://jira.spring.io/browse/DATAJPA-105</a></p>
<p><a href="http://jdpgrailsdev.github.io/blog/2014/09/09/spring_data_hibernate_join.html" target="_blank" rel="external">http://jdpgrailsdev.github.io/blog/2014/09/09/spring_data_hibernate_join.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[shiro登录]]></title>
      <url>https://winry.me/2016/05/13/shiro-login/</url>
      <content type="html"><![CDATA[<p>shiro默认的登录实现使用了用户名和密码进行验证。因为项目项目需要（使用了OAuth 2.0，不需要验证密码），改写了部分登录逻辑。在此记录一下主要用到的几个类。</p>
<p>AuthorizingRealm是验证登录以及获取权限的核心类。这个类是个抽象类，有两个待实现的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">AuthenticationInfo <span class="title">getAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span></span>;</span><br></pre></td></tr></table></figure>
<p>我们需要编写自己的Realm类继承这个抽象类并实现以上两个方法。<code>AuthenticationToken</code>包括确认用户身份的信息（比如username），以及登录凭证信息（比如password）。</p>
<p><code>AuthenticationInfo</code>包括了登录凭证信息以及凭证信息的验证原则。</p>
<p><code>AuthorizationInfo</code>包括了用户的角色以及权限信息。</p>
<p>需要注意的是AuthorizingRealm的父类里包含了要使用的<code>AuthenticationToken</code>类信息，其值是shiro的默认实现，<code>UsernamePasswordToken.class</code>。</p>
<p>如果你要实现自己的token，必须重新注入<code>authenticationTokenClass</code>。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[宿題]]></title>
      <url>https://winry.me/2016/05/07/nihongo-syukudai/</url>
      <content type="html"><![CDATA[<ul>
<li><p>那边那个穿蓝T恤的帅帅的男孩子不是我的男朋友</p>
<p>あそこの青いTシャツを着ているハンセムな男の子は私の彼氏じゃないです。</p>
</li>
</ul>
<ul>
<li><p>你知道叶子老师最近胖了三公斤吗</p>
<p>最近葉子先生が３キロ太ったのを知ってる？</p>
</li>
</ul>
<ul>
<li><p>妈妈走进房间的时候，看见熊猫君正在做广播体操。</p>
<p>母が部屋に入った時，パンダ君が广播体操をしているのを見た。</p>
</li>
<li><p>我把叶子酱送给我的围巾弄丢了。</p>
<p>葉子ちゃんにもらったマフラーを失くしました。</p>
</li>
<li><p>このマークはどう言う意味ですか</p>
<p>その標識は左に曲がるなと言う意味です。</p>
<p><img src="/img/mif4GpA.jpg" alt="mif4GpA"></p>
</li>
<li><p>地球太危险了，一起逃去火星吧</p>
<p>地球は危ないですから、一緒に火星に逃げよう。</p>
</li>
<li><p>请在以下句型中选择2~4个写一小段话，140字以内。</p>
<ol>
<li>～と、～。</li>
<li>～（る）ことがある。</li>
<li>～つもりだ。</li>
<li>～（だ）そうだ。</li>
</ol>
<p>突然アイドルに夢中になることもあるんですよね。毎日アイドルの映像見ないと、眠れない。私はアイドルにあうのに日本へ行くつもりだ、でも今年は無理だそうだ。</p>
</li>
<li><p>为了去日本旅游，我要提前学好日语</p>
<p>日本へ旅行するために、日本語を勉強しておきます。</p>
</li>
<li><p>AKB48的海报我放在柜子里了，你待会帮我送到森那里。</p>
<p>AKB48のポスターがロッカーに入ってあります、後で森さんに送って下さい。</p>
</li>
<li><p>这个平底锅只有在日本有卖，在中国买不到。</p>
<p>このフライパンは日本でしか売っでいなくて、中国で買うことができない。</p>
</li>
</ul>
<ul>
<li><p>请给我介绍一款拍猫好的相机。</p>
<p>猫を撮るのにいいカメラを紹介して下さい。</p>
</li>
<li><p>你知不知道森明天能不能来。</p>
<p>森さんが明日来られるかどうかしてる？</p>
</li>
<li><p>如果森不能来的话，就请小李来吧。</p>
<p>もし森さんが来られないなら、李さんに来てもらいましょう。</p>
</li>
<li><p>息子：我去趟便利店</p>
<p>母：好像要下雨了，带上伞去。</p>
<p>コンビニに行ってくる。</p>
<p>雨が降りそうで、傘を持って行って。</p>
</li>
<li><p>因为地震，刚建好的大楼倒塌了。</p>
<p>地震のために、できたばかりのビルが倒れた。</p>
</li>
<li><p>刚买的_手办被弟弟弄坏了，我现在正要去揍他。</p>
<p>最近買ったばがりフィギュアは弟に壊されて、今彼を殴りに行くところです。</p>
</li>
<li><p>A:小李穿着拖鞋就来公司上班了。</p>
<p>李さんはスリッパを履いたまま会社にきった。</p>
<p>B:小李是个认真的人，不可能做那样的事。</p>
<p>李さんは真面目なひとだから、そなことをするはずない。</p>
</li>
<li><p>用~すぎる结构造句<br>ぱるるは可愛い過ぎて、会いたかった。</p>
</li>
<li><p>用使役态造句<br>姉さんは僕にアイスを買わせました。</p>
</li>
<li><p>她好像被老妈逼着去相亲（お見合い）了。<br>彼はお母さんにお見合われさせました。</p>
</li>
<li><p>日语的发音很好听，日本的文化我也很喜欢，所以今后我会一直学习下去。<br>日本語の発音が綺麗だし、文化も好きだし、これからずっと勉強していこうと思います。</p>
</li>
<li>我想成为像A一样B的人。<br>ぱるるのような自由なひとになりたい。</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[raft（未完）]]></title>
      <url>https://winry.me/2016/04/26/raft-protocol/</url>
      <content type="html"><![CDATA[<h4 id="5-1_基本概念">5.1 基本概念</h4><p>​    一个Raft集群包括几个节点。五是一个典型的数量，这个数量使系统能够容错两次。每个节点在任何时候都处于以下三种状态之一：leader,follower,或candidate。运行正常的情况下，集群中有一个leader，其他节点都是followers。follower是被动的：它们不主动发起请求，只会响应来自leader或candidate的请求。leader处理所有的客户端请求（如果一个客户端与follower通讯，那么follower将转发请求给leader）。第三种状态，candidate，用于选举leader，选举将在5.2节详细说明。图例4展示了三种状态以及它们之间的转换，接下来就讨论状态之间的转换。</p>
<p>​    Raft被分割为不定长的terms。terms用连续的整数来编号。每个term从选举开始，选举中candidates将试图成为leader。如果一个candidate赢得了选举，那么该term剩下的时间中它将作为leader存在。某些情形下，选举会以分票告终。这种情况下，该term没有leader，一个新的term会马上开始。Raft确保每个term最多只有一个leader。</p>
<p>​    不同的节点可能在不同的时间点察觉到term的转换，在某些情况下，一个节点不会察觉到某次选举甚至整个term。term在Raft中起到扮演逻辑计时器的角色，它使各个节点能检测到过时的信息，比如过期的leader。每个节点都会存储current term，这个值会随着时间递增。节点之间通讯时会交换current terms信息，如果一个节点的current term小于其他人的，它会把它更新为较大的那个值。如果一个candidate或者leader发现它的term已经过时，它将立刻转为follower。如果一个节点接收到的请求包含了过时的term，它会拒绝该请求。</p>
<p>​    Raft节点之间通过远程过程调用（RPCs）通讯，最基本的一致性算法只需要两种类型的RPCs。RequestVote RPCs 在选举期间由candidates发起，Append-Entries RPCs 由leader发起，用于复制log，或者模拟心跳。第7节增加了第三种PRCs用于节点之间交换快照。如果没有收到响应，节点会及时的重试RPCs。为了更好的性能，RPCs将并行的进行。</p>
<h4 id="5-2选举">5.2选举</h4><p>​    Raft使用心跳机制来触发选举。节点启动之后，初始状态是followers。只要节点持续的收到来自leader或candidate的合法RPCs，它会一直保持follower的状态。Leaders周期性的发送心跳（不带leg entries的AppendEntries RPCs）来维持状态。如果一个follower一段时间没有收到请求，那么会发生选举超时，节点假定现在没有可用的leader，并开始选举一个新的leader。</p>
<p>​    当选举开始时，follower将term加一并转为candidate状态。然后它为自己投票并并行的向集群中的节点发起RequestVote RPCs。candidate保持其状态直到以下三种情况之一发生：(a)赢得选举，(b)其他节点声明自己是leader，(c)一段时间过去了而没有人胜出。以上三种结果会在下面的篇幅中分别讨论。</p>
<p>​    如果candidate收到集群中大部分节点相同term的投票，那么它将赢得选举。一个节点在一个term中最多只投一次票，按照先到先得的原则。多数票胜出原则保证了一个term当中最多只有一个candidate能赢得选举。一旦candidate赢得了选举，它的状态将转为leader。接着它会向其他节点发送心跳来防止新的选举。</p>
<p>​    等待投票的过程中，candidate可能会受到其他节点的AppendEntries RPC表示自己是leader。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[b站登陆以及发弹幕]]></title>
      <url>https://winry.me/2016/03/23/b%E7%AB%99%E7%99%BB%E9%99%86%E4%BB%A5%E5%8F%8A%E5%8F%91%E5%BC%B9%E5%B9%95/</url>
      <content type="html"><![CDATA[<p>本文只说明不使用验证码的登录，使用验证码的也是大同小异，打开B站F12然后登录，看一下HTTP报文就知道了。</p>
<h2 id="登录">登录</h2><p>登录密码需要加密（不过经测试，明文也是能登录的，如果用明文登录请跳至第三步），用的是RSA加密算法。</p>
<ol>
<li><p>首先要获取公钥：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">GET</span><span class="symbol">:https</span><span class="symbol">://passport</span>.bilibili.com/login?act=getkey&amp;_= + 当前时间</span><br></pre></td></tr></table></figure>
<p>返回的json类似这个样子：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;"<span class="attribute">hash</span>":<span class="value"><span class="string">"4d656f543748e605"</span></span>,"<span class="attribute">key</span>":<span class="value"><span class="string">"-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCdScM09sZJqFPX7bvmB2y6i08J\nbHsa0v4THafPbJN9NoaZ9Djz1LmeLkVlmWx1DwgHVW+K7LVWT5FV3johacVRuV98\n37+RNntEK6SE82MPcl7fA++dmW2cLlAjsIIkrX+aIvvSGCuUfcWpWFy3YVDqhuHr\nNDjdNcaefJIQHMW+sQIDAQAB\n-----END PUBLIC KEY-----\n"</span></span>&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>把hash值加到你的密码前面，然后用公钥加密。注意公钥是Base64编码过的，去掉头尾和换行之后要先解码。同样的，公钥加密之后的密文也要经过Base64编码。</p>
</li>
<li><p>登录请求：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">POST</span><span class="symbol">:https</span><span class="symbol">://passport</span>.bilibili.com/ajax/miniLogin/login</span><br></pre></td></tr></table></figure>
<p>随之还要提交一个表单，有四个字段。<br>“userid=用户名&amp;pwd=密码&amp;captcha=验证码&amp;keep=是否保持登录状态”<br>验证码填空就行，keep填1为是，0为否。<br>登录成功后，返回的json:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;"<span class="attribute">status</span>":<span class="value"><span class="literal">true</span></span>,"<span class="attribute">ts</span>":<span class="value"><span class="number">1458750856</span></span>,"<span class="attribute">data</span>":<span class="value">&#123;"<span class="attribute">code</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">crossDomain</span>":<span class="value"><span class="string">"https://passport.bilibili.com/crossDomain?DedeUserID=241087&amp;DedeUserID__ckMd5=7e772bf49d639da6&amp;Expires=1800&amp;SESSDATA=ed6f17cd%2C1458837256%2C7cd89c4f&amp;gourl=https%3A%2F%2Fpassport.bilibili.com%2Fajax%2FminiLogin%2Fredirect"</span></span>&#125;</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>crossDomain包含了你的cookie信息。这个信息是必须的，在发弹幕时需要用到，否则会提示你需要登录。<br>把DedeUserID，DedeUserID__ckMd5，SESSDATA三个值保存下来就行了。</p>
<h2 id="发弹幕">发弹幕</h2><p>发弹幕的请求：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">POST</span><span class="symbol">:http</span><span class="symbol">://live</span>.bilibili.com/msg/send</span><br></pre></td></tr></table></figure></p>
<p>需要提交表单，有六个字段。<br>“color=颜色&amp;fontSize=字体大小&amp;mode=模式&amp;msg=内容&amp;rnd=时间&amp;roomId=房间号”<br>颜色填固定值16777215，字体大小25，mode填1。<br>注意把你的Cookie添加到你的http header里去。<br>形如：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cookie: DedeUserID=<span class="number">241087</span>; DedeUserID__ckMd5=<span class="number">7e772</span>bf49d639da6; SESSDATA=ed6f17cd%<span class="number">2</span>C1458751426%<span class="number">2</span>C14f99d59;</span><br></pre></td></tr></table></figure></p>
<p>成功返回的json:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;"<span class="attribute">code</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">""</span></span>,"<span class="attribute">data</span>":<span class="value">[]</span>&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<p>能够模拟登陆之后，能够调用的API就很多了，发弹幕只是其中一个简单的例子，剩下的就自己尝试吧w。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[win常用软件]]></title>
      <url>https://winry.me/2016/03/16/win%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6/</url>
      <content type="html"><![CDATA[<p>自己常用的windows软件列表。</p>
<h4 id="editor">editor</h4><ul>
<li>Notepad2-mod</li>
<li>Atom</li>
<li>Typora</li>
<li>Sublime</li>
</ul>
<h4 id="sync">sync</h4><ul>
<li>Dropbox</li>
<li>坚果云</li>
<li>Seafile</li>
</ul>
<h4 id="im">im</h4><ul>
<li>QQLite</li>
<li>Telegram</li>
<li>Slack</li>
</ul>
<h4 id="reader">reader</h4><ul>
<li>SumatraPDF</li>
<li>Picassa</li>
</ul>
<h4 id="recoder">recoder</h4><ul>
<li>Bandicm</li>
<li>LICEcap</li>
</ul>
<h4 id="dowanload">dowanload</h4><ul>
<li>EagleGet</li>
</ul>
<h4 id="shell">shell</h4><ul>
<li>Babun</li>
</ul>
<h4 id="tunnel">tunnel</h4><ul>
<li>Ngrok</li>
</ul>
<h4 id="wireshark">wireshark</h4><ul>
<li>Fiddler</li>
</ul>
<h4 id="proxy">proxy</h4><ul>
<li>ShadowSocks</li>
<li>Lantern</li>
</ul>
<h4 id="ssh">ssh</h4><ul>
<li>PuTTY</li>
<li>WinSCP</li>
</ul>
<h4 id="mail">mail</h4><ul>
<li>FoxMail</li>
</ul>
<h4 id="office">office</h4><ul>
<li>LibreOffice</li>
</ul>
<h4 id="file">file</h4><ul>
<li>Everything</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Using and Currying in Java]]></title>
      <url>https://winry.me/2016/03/09/using-and-currying-in-java/</url>
      <content type="html"><![CDATA[<p>C#里面有一个常用的关键字using,它可以保证资源在使用完毕后被正常关闭,使得程序员不必手动的关闭资源.<br>use using:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (Font font1 = <span class="keyword">new</span> Font(<span class="string">"Arial"</span>, <span class="number">10.0f</span>))</span><br><span class="line">&#123;</span><br><span class="line">  byte charset = font1.GdiCharSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>without using:<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">&#123;</span><br><span class="line">  Font font1 = new Font<span class="list">(<span class="string">"Arial"</span>, <span class="number">10.0</span>f)</span><span class="comment">;</span></span><br><span class="line">  try</span><br><span class="line">  <span class="collection">&#123;</span><br><span class="line">    byte charset = font1.GdiCharSet;</span><br><span class="line">  &#125;</span></span><br><span class="line">  finally</span><br><span class="line">  <span class="collection">&#123;</span><br><span class="line">    if <span class="list">(<span class="keyword">font1</span> != null)</span></span><br><span class="line">    <span class="list">(<span class="list">(<span class="keyword">IDisposable</span>)</span>font1)</span>.Dispose<span class="list">()</span><span class="comment">;</span></span><br><span class="line">  &#125;</span></span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>java 7以后java里也有了类似的特性。如果一个类实现了java.lang.AutoCloseable，那么你可以使用如下的语法。<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">try</span>(ClassImplementingAutoCloseable obj = new <span class="function">ClassImplementingAutoCloseable</span>())</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来介绍如果一个类没有实现AutoCloseable，而又想实现类似using的功能应该怎么做。<br>MyFile是一个在使用之后需要被关闭的资源(需要调用close方法)。<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">class MyFile &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">String</span> fileName;</span><br><span class="line"></span><br><span class="line">  MyFile(<span class="keyword">String</span> fileName) &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.fileName = fileName;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> close() &#123;</span><br><span class="line">    System.out.<span class="built_in">println</span>(<span class="string">"closing file:"</span> + fileName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="built_in">print</span>() &#123;</span><br><span class="line">    System.out.<span class="built_in">println</span>(<span class="string">"fileName:"</span> + fileName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>MyFileHelper是MyFile的一个工具类。<br>currier接收第一个参数myFile，返回一个<code>Consumer&lt;Consumer&lt;MyFile&gt;&gt;</code>。<br>意思是这个consumer接收另外一个consumer作为参数（另外这个consumer才会真正的消费myFile）。<br>在currier的第二个参数被应用之前，它是不知道myFile会如何被消费的。<br>当然你也可以把consumer换成function，资源消费之后再产生一个结果。<br>这里用到了<a href="https://en.wikipedia.org/wiki/Currying" target="_blank" rel="external">Currying</a>，Currying是在函数式语言中接收单参数的函数模拟多参数的函数的技术。<br>使用Currying让它在语法上它更接近using，把资源的初始化和资源的处理分开。<br>同时，consumer和myfile两个参数能够在不同的地方被确定，它们可以被互相隔离的测试。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFileHelper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Consumer&lt;Consumer&lt;MyFile&gt;&gt; using(MyFile file) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">Function</span>&lt;<span class="title">MyFile</span>, <span class="title">Consumer</span>&lt;<span class="title">Consumer</span>&lt;<span class="title">MyFile</span>&gt;&gt;&gt; <span class="title">currier</span> = <span class="title">myFile</span> -&gt; <span class="title">consumer</span> -&gt; </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        consumer.accept(myFile);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          myFile.close();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      Consumer&lt;Consumer&lt;MyFile&gt;&gt; curried = currier.apply(file);</span><br><span class="line">      <span class="keyword">return</span> curried;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后是测试代码。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  MyFileHelper.<span class="keyword">using</span>(<span class="keyword">new</span> MyFile(<span class="string">"my-file"</span>)).accept(</span><br><span class="line">    myFile -&gt; myFile.print());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出:<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fileName:<span class="keyword">my</span>-<span class="type">file</span></span><br><span class="line">closing <span class="type">file</span>:<span class="keyword">my</span>-<span class="type">file</span></span><br></pre></td></tr></table></figure></p>
<p>完整的代码可以在这里看到：<br><a href="https://gist.github.com/fwrq41251/f6b82e201ff3b63d11ca" target="_blank" rel="external">gist</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Pattern matching in Java(续)]]></title>
      <url>https://winry.me/2015/11/30/pattern-matching-in-java(%E7%BB%AD)/</url>
      <content type="html"><![CDATA[<p>上一篇文章里翻译了java8以前模式匹配在java中的使用情况.<br>这一篇文章会简单介绍cyclops库中模式匹配的相关内容.<br><a href="https://github.com/aol/cyclops" target="_blank" rel="external">cyclops</a>是基于java8的一个扩展库,包括了模式匹配,stream工具类,monad,元组等内容.</p>
<p>直接上完整的代码.handleByType方法匹配类型,handleByValue方法匹配值.<br>isType方法传入一个名为TypedFunction的函数式接口,这个接口里有一个默认方法可以获取lanbda表达式中的泛型具体类型.<br>需要注意的是当需要值匹配时必须重写类的equals方法,因为Object中的equals方法认为两个不同的对象是不相等的.<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">package org.gradle.pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.aol.cyclops.matcher.builders.Matching;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Patterns</span> &#123;</span></span><br><span class="line"></span><br><span class="line">	abstract <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> &#123;</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Bar</span> <span class="keyword">extends</span> <span class="title">Foo</span> &#123;</span></span><br><span class="line"></span><br><span class="line">		public Bar(Integer bar) &#123;</span><br><span class="line">			<span class="keyword">super</span>();</span><br><span class="line">			<span class="keyword">this</span>.bar = bar;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		private Integer bar;</span><br><span class="line"></span><br><span class="line">		public Integer getBar() &#123;</span><br><span class="line">			<span class="keyword">return</span> bar;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		public <span class="literal">void</span> setBar(Integer bar) &#123;</span><br><span class="line">			<span class="keyword">this</span>.bar = bar;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Baz</span> <span class="keyword">extends</span> <span class="title">Foo</span> &#123;</span></span><br><span class="line"></span><br><span class="line">		public Baz(String baz) &#123;</span><br><span class="line">			<span class="keyword">super</span>();</span><br><span class="line">			<span class="keyword">this</span>.baz = baz;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		private String baz;</span><br><span class="line"></span><br><span class="line">		public String getBaz() &#123;</span><br><span class="line">			<span class="keyword">return</span> baz;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		public <span class="literal">void</span> setBaz(String baz) &#123;</span><br><span class="line">			<span class="keyword">this</span>.baz = baz;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="property">@Override</span></span><br><span class="line">		public int hashCode() &#123;</span><br><span class="line">			final int prime = <span class="number">31</span>;</span><br><span class="line">			int result = <span class="number">1</span>;</span><br><span class="line">			result = prime * result + getOuterType().hashCode();</span><br><span class="line">			result = prime * result + ((baz == <span class="literal">null</span>) ? <span class="number">0</span> : baz.hashCode());</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="property">@Override</span></span><br><span class="line">		public boolean equals(Object obj) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span> == obj)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			<span class="keyword">if</span> (obj == <span class="literal">null</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			<span class="keyword">if</span> (getClass() != obj.getClass())</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			Baz other = (Baz) obj;</span><br><span class="line">			<span class="keyword">if</span> (!getOuterType().equals(other.getOuterType()))</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			<span class="keyword">if</span> (baz == <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (other.baz != <span class="literal">null</span>)</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!baz.equals(other.baz))</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		private Patterns getOuterType() &#123;</span><br><span class="line">			<span class="keyword">return</span> Patterns.<span class="keyword">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Object handleByType(Foo foo) &#123;</span><br><span class="line">		<span class="keyword">return</span> Matching</span><br><span class="line">				.<span class="keyword">when</span><span class="function"><span class="params">()</span>.<span class="title">isType</span><span class="params">((Bar bar) -&gt; bar.getBar())</span></span><br><span class="line">				.<span class="title">when</span><span class="params">()</span>.<span class="title">isType</span><span class="params">((Baz baz) -&gt; baz.getBaz())</span></span><br><span class="line">				.<span class="title">match</span><span class="params">(foo)</span></span><br><span class="line">				.<span class="title">get</span><span class="params">()</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="title">Object</span> <span class="title">handleByValue</span><span class="params">(Foo foo)</span> &#123;</span><br><span class="line">		<span class="title">return</span> <span class="title">Matching</span></span><br><span class="line">				.<span class="title">when</span><span class="params">()</span>.<span class="title">isValue</span><span class="params">(<span class="keyword">new</span> Baz(<span class="string">"Luhrmann"</span>))</span>.<span class="title">thenApply</span><span class="params">(baz -&gt; baz.getBaz())</span></span><br><span class="line">				.<span class="title">match</span><span class="params">(foo)</span></span><br><span class="line">				.<span class="title">orElse</span><span class="params">(<span class="string">"match nothing"</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@<span class="title">Test</span></span><br><span class="line">	<span class="title">public</span> <span class="title">void</span> <span class="title">test</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="title">System</span>.<span class="title">out</span>.<span class="title">println</span><span class="params">(handleByType(<span class="keyword">new</span> Bar(<span class="number">42</span>)))</span>;          // 42</span><br><span class="line">		<span class="title">System</span>.<span class="title">out</span>.<span class="title">println</span><span class="params">(handleByType(<span class="keyword">new</span> Baz(<span class="string">"letty"</span>)))</span>;     // <span class="title">letty</span></span><br><span class="line">		<span class="title">System</span>.<span class="title">out</span>.<span class="title">println</span><span class="params">(handleByValue(<span class="keyword">new</span> Baz(<span class="string">"Luhrmann"</span>)))</span>; // <span class="title">Luhrmann</span></span><br><span class="line">		<span class="title">System</span>.<span class="title">out</span>.<span class="title">println</span><span class="params">(handleByValue(<span class="keyword">new</span> Baz(<span class="string">""</span>)))</span>;         // <span class="title">match</span> <span class="title">nothing</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>虽然和scala中的guard和case class相比,java中的模式匹配还是不够灵活,<br>然而这毕竟缺少了语言层面的支持.尽管如此,使用cyclops还是比起用访问者模式<br>在可读性和实现的难易度上都大大进步了.<br>预告:下一篇博客可能会继续介绍cyclops,或者是和动静态语言相关的内容.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Pattern matching in Java(翻译)]]></title>
      <url>https://winry.me/2015/11/04/pattern-matching-in-java/</url>
      <content type="html"><![CDATA[<p>模式匹配是一种来源于函数式语言的特性,它有点像java中的switch,<br>然而比switch更加强大,它除了能对值进行匹配之外还能对类型进行匹配.<br>配合scala的模板类,它能写出非常简洁的类型、值匹配的代码.<br>当你需要根据对象的类型或者值的不同来进行不同的逻辑处理时,就应该使用模式匹配.<br>下面的内容将主要针对其中的<strong>类型</strong>匹配展开.</p>
<h3 id="scala中的模式匹配">scala中的模式匹配</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">patterns</span> &#123;</span></span><br><span class="line">  <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span><br><span class="line"></span>  <span class="class"><span class="keyword">class</span> <span class="title">Bar</span>(</span><span class="function"><span class="keyword">val</span> <span class="title">bar</span>:</span> <span class="type">Int</span>) <span class="keyword">extends</span> <span class="type">Foo</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Baz</span>(</span><span class="function"><span class="keyword">val</span> <span class="title">baz</span>:</span> <span class="type">String</span>) <span class="keyword">extends</span> <span class="type">Foo</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle</span>(</span>f: <span class="type">Foo</span>) =</span><br><span class="line">    f <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> b: <span class="type">Bar</span> =&gt; b.bar</span><br><span class="line">      <span class="keyword">case</span> b: <span class="type">Baz</span> =&gt; b.baz</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  handle(<span class="keyword">new</span> <span class="type">Bar</span>(<span class="number">42</span>))                       <span class="comment">//&gt; res0: Any = 42</span></span><br><span class="line">  handle(<span class="keyword">new</span> <span class="type">Baz</span>(<span class="string">"Luhrmann"</span>))               <span class="comment">//&gt; res1: Any = Luhrmann</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面定义了一个抽象类Foo和两个子类Bar,Baz(object关键字说明这个类是单例的),<br>两个子类各有一个名称与类型都不同的成员属性,另外有一个handle方法来处理子类对象.<br>scala具有类型推导,所以这里没有声明方法的返回类型.</p>
<h3 id="java中的做法">java中的做法</h3><h4 id="instanceof">instanceof</h4><p>简单的做法是使用instanceof<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BadFoo</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  static <span class="class"><span class="keyword">class</span> <span class="title">Bar</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">BadFoo</span> &#123;</span></span><br><span class="line">    int bar;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Bar</span>(int bar) &#123;</span><br><span class="line">      <span class="keyword">this</span>.bar = bar;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  static <span class="class"><span class="keyword">class</span> <span class="title">Baz</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">BadFoo</span> &#123;</span></span><br><span class="line">    <span class="type">String</span> baz;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Baz</span>(<span class="type">String</span> baz) &#123;</span><br><span class="line">      <span class="keyword">this</span>.baz = baz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  static void handle(<span class="type">BadFoo</span> f) &#123;</span><br><span class="line">    <span class="keyword">if</span> (f instanceof <span class="type">Bar</span>) &#123;</span><br><span class="line">      <span class="type">Bar</span> b = (<span class="type">Bar</span>) f;</span><br><span class="line">      <span class="type">System</span>.out.println(<span class="string">"I have "</span> + b.bar + <span class="string">" bars"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f instanceof <span class="type">Baz</span>) &#123;</span><br><span class="line">      <span class="type">Baz</span> b = (<span class="type">Baz</span>) f;</span><br><span class="line">      <span class="type">System</span>.out.println(<span class="string">"I have the "</span> + b.baz + <span class="string">" baz"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public static void main(<span class="type">String</span>[] args) &#123;</span><br><span class="line">    handle(<span class="keyword">new</span> <span class="type">Bar</span>(<span class="number">42</span>));</span><br><span class="line">    handle(<span class="keyword">new</span> <span class="type">Baz</span>(<span class="string">"Luhrmann"</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然而这么写有几个问题,1.在那些使用动态代理的代码中,产生的对象永远不会是原始类的一个实例,<br>instanceof不起作用.2.无法在编译时期进行类型判断,<code>if (f instanceof Bar) Baz b = (Baz) f;</code><br>以上代码能编译通过,但是不能运行.3.当增加了一个新的子类时,不能保证旧代码被及时更新.</p>
<h4 id="Moving_logic_into_the_class">Moving logic into the class</h4><p>另一种做法是把逻辑放到数据对象中,就像OOP应该做的.<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">OoFoo</span> &#123;</span></span><br><span class="line">  <span class="keyword">abstract</span> void handle();</span><br><span class="line"></span><br><span class="line">  static <span class="class"><span class="keyword">class</span> <span class="title">Bar</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">OoFoo</span> &#123;</span></span><br><span class="line">    <span class="keyword">private</span> int bar;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Bar</span>(int bar) &#123;</span><br><span class="line">      <span class="keyword">this</span>.bar = bar;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    void handle() &#123;</span><br><span class="line">      <span class="type">System</span>.out.println(<span class="string">"I have "</span> + bar + <span class="string">" bars"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  static <span class="class"><span class="keyword">class</span> <span class="title">Baz</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">OoFoo</span> &#123;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> baz;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Baz</span>(<span class="type">String</span> baz) &#123;</span><br><span class="line">      <span class="keyword">this</span>.baz = baz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    void handle() &#123;</span><br><span class="line">      <span class="type">System</span>.out.println(<span class="string">"I have the "</span> + baz + <span class="string">" baz"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public static void main(<span class="type">String</span>[] args) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">Bar</span>(<span class="number">42</span>).handle();</span><br><span class="line">    <span class="keyword">new</span> <span class="type">Baz</span>(<span class="string">"Luhrmann"</span>).handle();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这么做刚开始还不错,然而当类似的方法逐渐变多,你的数据对象就变成了存放业务逻辑的地方.<br>使用访问者模式能够保持数据对象简单,把业务逻辑放到响应的处理类中.</p>
<h3 id="访问者模式">访问者模式</h3><h4 id="Basic_Visitor">Basic Visitor</h4><p>基本的访问者模式包括以下内容:</p>
<ul>
<li>一个抽象类或者接口包括一个以Visitor作为参数,返回类型为Visitor中泛型类型的方法match</li>
<li>一个Visitor类,包括各个子类对象为参数的case方法</li>
<li>一系列实现了match方法的子类</li>
<li>实现各个case方法的应用代码<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">  <span class="keyword">abstract</span> &lt;T&gt; <span class="function">T <span class="title">match</span><span class="params">(Visitor&lt;T&gt; visitor)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">interface</span> <span class="title">Visitor</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">caseBar</span><span class="params">(Bar b)</span></span>;</span><br><span class="line">    <span class="function">T <span class="title">caseBaz</span><span class="params">(Baz b)</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Bar</span> <span class="keyword">extends</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> bar;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Bar</span><span class="params">(<span class="keyword">int</span> bar)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.bar = bar;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">match</span><span class="params">(Visitor&lt;T&gt; visitor)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> visitor.caseBar(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Baz</span> <span class="keyword">extends</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String baz;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Baz</span><span class="params">(String baz)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.baz = baz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">match</span><span class="params">(Visitor&lt;T&gt; visitor)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> visitor.caseBaz(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Foo f)</span> </span>&#123;</span><br><span class="line">    System.out.println(f.match(<span class="keyword">new</span> Visitor&lt;String&gt;() &#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> String <span class="title">caseBar</span><span class="params">(Bar b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"I have "</span> + b.bar + <span class="string">" bars"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> String <span class="title">caseBaz</span><span class="params">(Baz b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"I have the "</span> + b.baz + <span class="string">" baz"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    handle(<span class="keyword">new</span> Bar(<span class="number">42</span>));</span><br><span class="line">    handle(<span class="keyword">new</span> Baz(<span class="string">"Luhrmann"</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="Default_visitor">Default visitor</h4><p>有时候Visitor没必要重写全部的case方法,只重写部分方法,其他时候返回默认值.<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefaultFooVisitor</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Foo</span>.<span class="title">Visitor</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  T defaultValue;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">DefaultFooVisitor</span><span class="params">(T defaultValue)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.defaultValue = defaultValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function">T <span class="title">caseBar</span><span class="params">(Bar b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> defaultValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function">T <span class="title">caseBaz</span><span class="params">(Baz b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> defaultValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="keyword">int</span> <span class="title">countBars</span><span class="params">(Foo f)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> f.<span class="title">match</span><span class="params">(<span class="keyword">new</span> DefaultFooVisitor&lt;Integer&gt;(<span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="function">Integer <span class="title">caseBar</span><span class="params">(Bar b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> b.bar;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>缺点是当增加了新的子类,新增的case方法可能会忘记重写.<br>解决这个问题的一种方法是先把DefaultFooVisitor中新增的case方法改为抽象的,<br>解决了所有的编译问题之后再来实现DefaultFooVisitor中新增的case方法.</p>
<h4 id="Void_or_Unit_return_values">Void or Unit return values</h4><p>有时候返回值是不需要的,可以用<code>Unit.unit</code>或者<code>java.lang.Void</code>来表达空的返回类型.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PartitionFoos</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">doStuff</span><span class="params">(Collection&lt;Foo&gt; foos)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;Bar&gt; bars = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">final</span> List&lt;Baz&gt; bazes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Foo f : foos) &#123;</span><br><span class="line">      f.match(<span class="keyword">new</span> Visitor&lt;Void&gt;() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Void <span class="title">caseBar</span><span class="params">(Bar b)</span> </span>&#123;</span><br><span class="line">          bars.add(b);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Void <span class="title">caseBaz</span><span class="params">(Baz b)</span> </span>&#123;</span><br><span class="line">          bazes.add(b);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="解构模式匹配">解构模式匹配</h3><p>前面的例子都只包含了类型匹配,最后的一个例子会展示java处理包含类型以及值匹配的方法.<br>先来看一下scala的代码:<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">patterns</span> &#123;</span></span><br><span class="line">  <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span><br><span class="line"></span>  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Bar</span>(</span><span class="function"><span class="keyword">val</span> <span class="title">bar</span>:</span> <span class="type">Int</span>) <span class="keyword">extends</span> <span class="type">Foo</span></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Baz</span>(</span><span class="function"><span class="keyword">val</span> <span class="title">baz</span>:</span> <span class="type">String</span>) <span class="keyword">extends</span> <span class="type">Foo</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle</span>(</span>f: <span class="type">Foo</span>) =</span><br><span class="line">    f <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">Bar</span>(i) <span class="keyword">if</span> (i &gt; <span class="number">10</span>) =&gt; <span class="number">10</span></span><br><span class="line">      <span class="keyword">case</span> <span class="type">Bar</span>(i) =&gt; i</span><br><span class="line">      <span class="keyword">case</span> <span class="type">Baz</span>(s) =&gt; s</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  handle(<span class="keyword">new</span> <span class="type">Bar</span>(<span class="number">42</span>))                             <span class="comment">//&gt; res0: Any = 10</span></span><br><span class="line">  handle(<span class="keyword">new</span> <span class="type">Bar</span>(<span class="number">3</span>))                              <span class="comment">//&gt; res0: Any = 3</span></span><br><span class="line">  handle(<span class="keyword">new</span> <span class="type">Baz</span>(<span class="string">"Luhrmann"</span>))                     <span class="comment">//&gt; res1: Any = Luhrmann</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>简洁,灵活.再来看一下java版本的:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">  <span class="keyword">abstract</span> &lt;T&gt; <span class="function">T <span class="title">match</span><span class="params">(Visitor&lt;T&gt; visitor)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">interface</span> <span class="title">Visitor</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">caseManyBar</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">T <span class="title">caseBar</span><span class="params">(<span class="keyword">int</span> i)</span></span>;</span><br><span class="line">    <span class="function">T <span class="title">caseBaz</span><span class="params">(String s)</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Bar</span> <span class="keyword">extends</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> bar;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Bar</span><span class="params">(<span class="keyword">int</span> bar)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.bar = bar;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">match</span><span class="params">(Visitor&lt;T&gt; visitor)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> bar &gt; <span class="number">10</span> ? visitor.caseManyBar() : visitor.caseBar(bar);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Baz</span> <span class="keyword">extends</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String baz;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Baz</span><span class="params">(String baz)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.baz = baz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">match</span><span class="params">(Visitor&lt;T&gt; visitor)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> visitor.caseBaz(baz);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Foo f)</span> </span>&#123;</span><br><span class="line">    System.out.println(f.match(<span class="keyword">new</span> Visitor&lt;String&gt;() &#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> String <span class="title">caseBar</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"I have "</span> + i + <span class="string">" bars"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> String <span class="title">caseManyBar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"I have many bars"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> String <span class="title">caseBaz</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"I have the "</span> + s + <span class="string">" baz"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    handle(<span class="keyword">new</span> Bar(<span class="number">42</span>));</span><br><span class="line">    handle(<span class="keyword">new</span> Bar(<span class="number">3</span>));</span><br><span class="line">    handle(<span class="keyword">new</span> Baz(<span class="string">"Luhrmann"</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>16vs58,很难说用多余的42行来模拟相同的功能是否值得.<br>访问者模式的好处是,让你以一种类型安全的方式来处理子类.<br>在你添加新的子类时,编译器会告诉你哪些代码需要修改.<br>当你下一次遇到ClassCastException时你应该考虑使用它.</p>
<p>原文:<br><a href="http://eng.wealthfront.com/2015/02/pattern-matching-in-java-with-visitor.html" target="_blank" rel="external">Pattern matching in Java with the Visitor pattern</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[java内存探险(待续)]]></title>
      <url>https://winry.me/2015/10/13/java%E5%86%85%E5%AD%98%E6%8E%A2%E9%99%A9/</url>
      <content type="html"><![CDATA[<p>之前写的b站直播订阅通知的程序内存占用始终不能满意,<br>想到java是跑在jvm上的,<br>是否jvm本身就需要占用那么多的内存呢,<br>决定打开jconsole来看一看.<br>java内存分为堆和非堆,来看定义:</p>
<blockquote>
<h5 id="Heap_memory">Heap memory</h5><p>The heap memory is the runtime data area from which the Java VM allocates memory for all class instances and arrays. The heap may be of a fixed or variable size. The garbage collector is an automatic memory management system that reclaims heap memory for objects.</p>
<ul>
<li><p>Eden Space: The pool from which memory is initially allocated for most objects.</p>
</li>
<li><p>Survivor Space: The pool containing objects that have survived the garbage collection of the Eden space.</p>
</li>
<li><p>Tenured Generation: The pool containing objects that have existed for some time in the survivor space.</p>
</li>
</ul>
<h5 id="Non-heap_memory">Non-heap memory</h5><p>Non-heap memory includes a method area shared among all threads and memory required for the internal processing or optimization for the Java VM. It stores per-class structures such as a runtime constant pool, field and method data, and the code for methods and constructors. The method area is logically part of the heap but, depending on the implementation, a Java VM may not garbage collect or compact it. Like the heap memory, the method area may be of a fixed or variable size. The memory for the method area does not need to be contiguous.</p>
<ul>
<li><p>Permanent Generation: The pool containing all the reflective data of the virtual machine itself, such as class and method objects. With Java VMs that use class data sharing, this generation is divided into read-only and read-write areas.</p>
</li>
<li><p>Code Cache: The HotSpot Java VM also includes a code cache, containing memory that is used for compilation and storage of native code.</p>
</li>
</ul>
</blockquote>
<p>我的程序的堆内存占用:<br><img src="/img/561cad5c33358.png" alt=""><br>这个程序每五分钟会去爬一次直播间的直播状态,<br>在这个点上堆内存占用升高,<br>GC之后又回落下来,<br>整体上在6.5M左右徘徊,<br>问题不大.<br>再来看非堆:<br><img src="/img/561cae38326d2.png" alt=""><br>整体30M左右,基本上不变化.</p>
<hr>
<p>实际上JAVA程序在启动时可以指定内存占用的大小,<br><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-Xms128m -Xmx256m</span></span><br></pre></td></tr></table></figure></p>
<p>上面这行代码就指定了堆的初始化内存为128MB,最大为256MB.<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"><span class="constant">XX</span><span class="symbol">:PermSize256m</span> <span class="constant">XX</span><span class="symbol">:MaxPermSize512m</span></span></span><br></pre></td></tr></table></figure></p>
<p>上面这行代码用来指定非堆内存的永久代(<strong>PermGen</strong>)大小.<br>然而我试过将MaxPermSize设为20m,<br>非堆内存占用并没有什么变化.</p>
<hr>
<p>手头上还有一个舰娘的辅助程序,从github上下载的,<br>来看一下它的内存占用.<br>堆内存:<br><img src="/img/561cb1413c8a5.png" alt=""><br>非堆:<br><img src="/img/561cb18c012a9.png" alt=""><br>非堆几乎是一样的.</p>
<p>这下可以安心了,自己的程序内存占用是正常的.<br>参考:<br><a href="https://docs.oracle.com/cd/E22289_01/html/821-1274/configuring-the-default-jvm-and-java-arguments.html" target="_blank" rel="external">Configuring JVM Options</a><br><a href="http://stackoverflow.com/questions/1493913/how-to-set-the-maximum-memory-usage-for-jvm" target="_blank" rel="external">How to set the maximum memory usage for JVM</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[博客启用https(支持hexo)]]></title>
      <url>https://winry.me/2015/10/09/%E5%8D%9A%E5%AE%A2%E5%90%AF%E7%94%A8https/</url>
      <content type="html"><![CDATA[<ol>
<li><a href="https://www.cloudflare.com/" target="_blank" rel="external">CloudFlare</a>是目前唯一一家提供免费ssl的cdn,注册完设置好nameserver之后大约等一个多小时,<br>网站就可以使用https访问了.<br><a href="https://www.ssllabs.com" target="_blank" rel="external">ssllabs</a>的测试结果:<br><img src="/img/56179c7581b1d.jpg" alt="" title="result"><br>从图中可以看到,浏览器必须支持sni.</li>
<li><p>然后就是让用户的http请求跳转到https.<br>在 <code>layout/_scripts</code> 目录下加一个 script,然后在 <code>layout/_layout.swig</code> 中 include 进去.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span><br><span class="line">    <span class="keyword">var</span> host = <span class="string">"yoursite.com"</span>;</span><br><span class="line">    <span class="keyword">if</span> ((host == <span class="built_in">window</span>.location.host) &amp;&amp; (<span class="built_in">window</span>.location.protocol != <span class="string">"https:"</span>))</span><br><span class="line">        <span class="built_in">window</span>.location.protocol = <span class="string">"https"</span>;</span><br><span class="line"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置网站的url,让google等搜索引擎知道你正在使用ssl.<br>在<code>_config.yml</code>中增加:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">url</span>: <span class="attribute">https</span>:<span class="comment">//www.yoursite.com   # with the https protocol</span></span><br><span class="line"><span class="attribute">enforce_ssl</span>: www.yoursite.com   # without any protocol</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>参考:<br><a href="https://sheharyar.me/blog/free-ssl-for-github-pages-with-custom-domains/" target="_blank" rel="external">Set Up SSL on Github Pages With Custom Domains for Free</a><br><a href="https://github.com/iissnan/hexo-theme-next/issues/123" target="_blank" rel="external">HTTPS下点击页面自动跳转HTTP</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Java8 Mixin]]></title>
      <url>https://winry.me/2015/09/15/java8-mixin/</url>
      <content type="html"><![CDATA[<p>java8开始接口支持了默认方法,从此mixin也变为可能了.</p>
<p>先来看看mixin是什么:</p>
<blockquote>
<p>In object-oriented programming languages, a mixin is a class that contains a <strong><em>combination</em></strong> of methods from other classes. How such a combination is done depends on the language. If a combination contains all methods of combined classes, it is equivalent to <strong><em>multiple inheritance</em></strong>. Mixins are sometimes described as being “included” rather than “inherited”.</p>
<p>Mixins encourage code reuse and can be used to avoid the inheritance ambiguity that multiple inheritance can cause (the “<a href="https://en.wikipedia.org/wiki/Multiple_inheritance#The_diamond_problem" target="_blank" rel="external">diamond problem</a>“), or to work around lack of support for multiple inheritance in a language. A mixin can also be viewed as an <strong><em>interface with implemented methods</em></strong>.</p>
</blockquote>
<p>mixin混合了其他类的功能但是又不会引发多重继承的问题.</p>
<p>下面是一个简单的迭代器.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AbsIterator</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">next</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>给上面的迭代器增加了foreach方法,接收一个consumer,<br>对每个元素执行相同的操作.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RichIterator</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbsIterator</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">default</span> <span class="keyword">void</span> <span class="title">foreach</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> T&gt; consumer)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (hasNext())</span><br><span class="line">			consumer.accept(next());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个基于String的实现.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringIterator</span> <span class="keyword">implements</span> <span class="title">AbsIterator</span>&lt;<span class="title">Character</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String s;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">StringIterator</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.s = s;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> i &lt; s.length();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Character <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Character character = s.charAt(i);</span><br><span class="line">		i++;</span><br><span class="line">		<span class="keyword">return</span> character;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后是一个测试类.<br>测试用的迭代器即有StringIterator的实现,<br>又具有RichIterator的foreach方法.<br>在java8以前我们要怎么做这件事呢,<br>似乎是没法做,<br>由于接口没有默认方法,<br>我们必须在每个迭代器实现中重写foreach方法.<br>mixin增强了代码的重用能力.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringIteratorTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Iter iter = <span class="keyword">new</span> Iter(<span class="string">"test"</span>);</span><br><span class="line">		iter.foreach(System.out::println);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Iter</span> <span class="keyword">extends</span> <span class="title">StringIterator</span> <span class="keyword">implements</span> <span class="title">RichIterator</span>&lt;<span class="title">Character</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">Iter</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">super</span>(s);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不过值得注意的是，java的mixin比scala在功能还是要弱一些，由于scala有with关键字，可以在实例化时进行mixin，可以直接强化trait的方法，类似于装饰器的作用。java里子类的实现则会直接覆盖掉父类。</p>
<p>参考:<a href="http://www.scala-lang.org/old/node/117" target="_blank" rel="external">scala-mixin</a></p>
]]></content>
    </entry>
    
  
  
</search>
